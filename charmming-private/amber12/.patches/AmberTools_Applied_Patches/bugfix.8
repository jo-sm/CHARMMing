********>Bugfix 8:
Authors: Matthew Clark, Mike Wu, Jason Swails & Ross Walker

Date:   June 20th, 2012

Programs: Configure File (affects pmemd.cuda and pmemd.cuda.MPI) 

Description: 
             1) Fixes unresolved symbols seen when compiling the CUDA
                code on certain newer versions of Ubuntu and possibly
                other Linux installations using GNU v4.6 or later
                compilers.
             2) Removes the dependence on MPI_HOME in the compilation
                of the CUDA MPI code and attempts to determine the
                location of MPI include files from mpicc instead of
                relying on $MPI_HOME/include. This fixes possible issues
                with mpi.h not being found when using system installed
                MPI instances.

------------------------------------------------------------------------------

--- AmberTools/src/configure2	2012-06-20 12:53:28.578828798 -0700
+++ AmberTools/src/configure2	2012-06-20 13:09:32.826114050 -0700
@@ -594,13 +594,6 @@
         exit 1
       fi
     fi
-
-    # We need $MPI_HOME/include in the PMEMD_CU_INCLUDES for cuda.MPI. Get it from
-    # The location of mpif90 unless MPI_HOME is set.
-    if [ -z "$MPI_HOME" ]; then
-      tmp_mpi_home=`dirname \`which mpif90\``
-      MPI_HOME=`dirname $tmp_mpi_home`
-    fi
 fi
 
 #------------------------------------------------------------------------------
@@ -1016,7 +1009,7 @@
 
         pmemd_cu_includes='-I$(CUDA_HOME)/include -IB40C -IB40C/KernelCommon'
         pmemd_cu_defines='-DCUDA'
-        pmemd_cu_libs='-L$(CUDA_HOME)/lib64 -L$(CUDA_HOME)/lib -lcurand -lcufft -lcudart ./cuda/cuda.a'
+        pmemd_cu_libs='./cuda/cuda.a -L$(CUDA_HOME)/lib64 -L$(CUDA_HOME)/lib -lcurand -lcufft -lcudart'
         if [ "$optimise" = 'yes' ]; then
             nvcc='$(CUDA_HOME)/bin/nvcc -use_fast_math -O3 -gencode arch=compute_13,code=sm_13 -gencode arch=compute_20,code=sm_20'
         else
@@ -1024,7 +1017,8 @@
         fi
 
         if [ "$mpi" = 'yes' ]; then
-          pmemd_cu_includes="$pmemd_cu_includes -I$MPI_HOME/include"
+          mpi_inc=`mpicc -show | awk 'BEGIN{i=0} {while (i < NF) {if ( substr($i, 1, 2) == "-I" ) {printf("%s ", $i);}; i++;}}'`
+          pmemd_cu_includes="$pmemd_cu_includes $mpi_inc"
           pmemd_cu_defines="$pmemd_cu_defines -DMPI -DMPICH_IGNORE_CXX_SEEK"
           pmemd_coptflags="$pmemd_coptflags -DMPICH_IGNORE_CXX_SEEK"
         fi


