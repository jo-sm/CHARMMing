{% extends "input_scripts/generic_charmm_script.inp" %} blankme

{% block title %}Solvate Protein {% endblock %}
   ! solvation structure is {{solvation_structure}}

{% block body %} blankme

   ! orient about origin so the alignment is correct with the
   ! water crystal.
   coordinate orient

   ! Read in water sequence
   read sequ tip3 46656

   ! Generate new segment for the water
   generate bwat noangle nodihedral

   ! Read the water coordinates and append them to the protein
   read coor card append name /usr/local/charmming/solvation/water.crd
   coor orient noro select segid bwat end

   ! Delete waters which overlap with protein
   delete atom sort -
   select .byres. (segid bwat .AND. type oh2 .and. -
   ((.not. (segid bwat .OR. hydrogen)) .around. 2.5)) end

   ! cut the water box down to a sphere
   delete atom sort select .byres. ( .not. ( point 0. 0. 0. cut {{ spradius }} ) .and. ( segid bwat ) ) end
   {% ifnotequal solvation_structure "sphere" %}
      ! handle periodic unit cell, as follows: define the crystallographic
      ! unit cell and set up images. Then force an image update. Any atoms
      ! that have moved were originally outside of the unit cell and may
      ! be deleted.
      crystal define {{ solvation_structure }} {{ xtl_x }} {{ xtl_y }} {{ xtl_z }} {{ angles }}
      crystal build noper 0
      image byres sele segid bwat end

      wrnlev 1 ! temporarily reduce number of warnings
      coor copy comp ! back-up current coordinates to the comp set
      update inbfrq 0 ! force image update

      coor diff ! find differences between main and comp set
      define sel1 select .byres. (property x .ne. 0.0 .or. property y .ne. 0.0 .or. property z .ne. 0.0) end
      delete atom select sel1 end

      wrnlev 5  ! restore old warning level
      coor copy ! restore original coordinates
   {% endifnotequal %}

   {% include 'input_scripts/use_shake.inp' %}
   ! The TIP3 water model is only valid with SHAKE, so let's turn it on
   shake bonh param

   ! Do a quick and dirty minimization to reduce bad image contacts...
   update inbfrq -1 ! heuristic updates
   mini sd nstep 50 nprint 1 tolgrd 50.0
   {% include 'input_scripts/write_out_struct.inp' %}
{% endblock %}

