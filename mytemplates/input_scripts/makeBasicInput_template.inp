{% extends "input_scripts/generic_charmm_script.inp" %} blankme

{% block title %}Run Segment Through CHARMM {% endblock %}

{% block body %} blankme

{% ifequal seg 'sequ-pro' %} blankme
  read sequence card
  *User-defined Sequence
  *
  {{ number_of_sequences }}
  {{ sequ_line }}

  generate {{ segid }} setup

  ic para
  ic seed 1 N 1 CA 1 C
  ic build

  coor orie
  hbuild

{% else %}
  read sequence pdb name new_{{ filebase }}-{{ segid }}{{ suffix }}.pdb

  {% if segpatch_name %}
    {% if endswith_het  %}
      generate {{ segid }} setu FIRS NONE LAST NONE
    {% else %}
      {% for larr in larr_list %}
        {{ larr }}
      {% endfor %}
    {% endif %}
  {% else %}
     {% if endswith_dna %}
         ! patch sugars to make them deoxyribose instead of ribose
         ! we must use the DEO1 patch for pyrimidines (CYT, THY, URA)
         ! and the DEO2 patch for purines (ADE, GUA)
         set rnum = 0
         label deoxloop
         calc rnum = @rnum + 1

         define theres select resid @rnum end
         set pname = DEO1
         if ?selresn .eq. ADE then set pname = DEO2
         if ?selresn .eq. GUA then set pname = DEO2
         patch @pname {{ segid }} @rnum setup warn
         autogenerate angles dihedrals

         if @rnum .lt. ?nres then goto deoxloop
     {% else %}{% if endswith_rna %}
         generate {{ segid }} setu FIRS 5TER LAST 3TER
     {% else %}{% if line_is_goodhet %}
         generate {{ segid }} NOANG NODIH setup
     {% else %}{% if endswith_het %}
         generate {{ segid }} setu FIRST NONE LAST NONE
     {% else %}
         generate {{ segid }} setu
     {% endif %}{% endif %}{% endif %}{% endif %}

  {% endif %}

  read coor pdb name new_{{ filebase }}-{{ segid }}{{ suffix }}.pdb
  ic para
  ic fill preserve
  ic build
  hbuild
{% endifequal %}

! write out the protein structure file (psf) and
! the coordinate file in pdb and crd format.

write psf card name new_{{ filebase }}{{ output_line }}-final.psf unit 1
* PSF
*

write coor pdb name new_{{ filebase }}{{ output_line }}-final.pdb unit 1
* PDB Coords
*

write coor card name new_{{ filebase }}{{ output_line }}-final.crd unit 1
* Coords
*
{% endblock %} blankme
