{% extends "input_scripts/generic_charmm_script.inp" %} blankme

{% block title %}Molecular Dynamics {% endblock %}

{% block body %} blankme
   {% include 'input_scripts/solvate_implicity.inp' %}

   ! read crystal dimensional data from the crystal structure made in solvation
   {% if usepbc %} blankme
      crystal defi {{ xtl_ucell }} {{ xtl_x }} {{ xtl_y }} {{ xtl_z }} {{ xtl_angles }}  
      crystal build noper 0

      {% include 'input_scripts/zero_charge.inp' %}
   {% endif %} blankme

   {% ifequal strtword "restart" %}
       open unit 40 read card name {{restartname}} ! restart file that will be read
   {% endifequal %}
   open unit 41 write card name {{outname}}-md.res !restart file that will be written
   open unit 31 write file name {{outname}}-md.dcd !trajectory file name

   {% include 'input_scripts/write_out_struct.inp'%}

   {% if genavg_struct %}
      CHARMM-scripts open unit 31 read file name {{outname}}-md.dcd
      CHARMM-scripts coor dyna firstu 31 nunit 1 sele .not. segid bwat end orient sele .not. segid bwat end
      CHARMM-scripts write coor card name {{outname}}-mdavg.crd
      CHARMM-scripts * Average coordinates from MD
      CHARMM-scripts *
   {% endif %}
{% endblock %}

   {% ifequal md 'useheat' %} blankme
      dyna leap verlet {{ strtword }} -
      {% if dopbc %} blankme
         pcons - !use constant pressure
         pint - !use internal virial for calc pressure
         pref 1.0 - !reference pressure in atm
         pmass @pmass - !piston mass
         pgamma 0.0 - !Langevin piston collision frequency
      {% endif %} blankme
      timestep 0.001 - !timestep in picoseconds
      nstep {{nstep}} - !number of steps and energy evaluations
      nprint 100 - !step frequency for writing in kunit and printing energy on unit 6
      iunwri 41 - !unit to write restart file
      iuncrd 31 - !unit to write coordinates (unformatted)
      {% ifequal strtword "restart" %} blankme
        iunrea 40 -
      {% else %} blankme
        iunrea -1 - !unit to read in restart file
      {% endifequal %} blankme
      kunit -1 - !unit to write temperature and total energy
      firstt {{firstt}} - !initial temperature of the system
      finalt {{finalt}} - !final temperature of the system
      ihtfrq {{ihtfrq}} - !frequency to increase temperature by TEMINC
      teminc {{teminc}} - !value to increase temperature by
      tbath {{tbath}} - !temperature of heath bath
      iprfrq {{ihtfrq}} - !frequency for avg and rms energy
      ieqfrq {{ihtfrq}} - !frquency to assign or scale velocities to match FINALT temperature
      ntrfrq {{ihtfrq}} - !frequency for stopping the rotation and translation of the system during dynamics
      nsavc {{ndcd}} - !frequency for writing coordinates
      nsavv 0 - !frequency for writing velocities
      ihbfrq 0 - !frequency to regenerate hydrogen bond list
      ilbfrq 0 - !frequency to check for atoms in Langevin region
      iseed 11033 - !seed for the random number generator in assigning velocities
      echeck 500. - !max variation of energy step-to-step
      iasors 1 - !assign (NOT scale) velocities during heating/equil
      iasvel 1 - !use gaussian distribution of velocities
      iscvel 0 - !single scale factor
      ichecw 1 - !checks to make sure avg temperature lies within a window
      twindh 5.0 - !Highest deviation allowed of FINALT on the high side
      twindl 5.0 !Highest deviation allowed of FINALT on the low side
   {% else %} blankme
      {% if dopbc %} blankme
         dyna cpt {{ strtword }} -
      {% else %} blankme
         dyna leap verlet {{ strtword }} -
      {% endif %} blankme
      CHARMM-scripts  timestep 0.001 - !timestep in picoseconds
      CHARMM-scripts  nstep {{nstep}} - !number of steps and energy evaluations
      CHARMM-scripts  echeck 100. - !max variation of energy step-to-step
      {% if dopbc %} blankme
         CHARMM-scripts  pcons - !use constant pressure
         CHARMM-scripts  pint - !use internal virial for calc pressure
         CHARMM-scripts  pref 1.0 - !reference pressure in atm
         CHARMM-scripts  pmass @pmass - !piston mass
         CHARMM-scripts  pgamma 0.0 - !Langevin piston collision frequency
         CHARMM-scripts  hoover - !Hoover temperature control
         CHARMM-scripts  reft {{temp}} - !Hoover reference temperature
         CHARMM-scripts  tmass @tmass - !mass of thermal piston
      {% endif %} blankme 
      CHARMM-scripts  iprfrq 10 - !frequency for avg and rms energy
      CHARMM-scripts  ieqfrq 0  - !frquency to assign or scale velocities to match FINALT temperature
      CHARMM-scripts  ntrfrq 10 - !frequency for stopping the rotation and translation of the system during dynamics
      {% ifequal strtword "restart" %} blankme
         CHARMM-scripts  iunrea 40 -
      {% else %} blankme
         CHARMM-scripts  iunrea -1 - !unit to read in restart file
      {% endifequal %} blankme
      CHARMM-scripts  iunwri 41 - !unit to write restart file
      CHARMM-scripts  iuncrd 31 - !unit to write coordinated (unformatted)
      CHARMM-scripts  nprint 100 - !step frequency for writing in kunit and printing energy on unit 6
      CHARMM-scripts  nsavc {{ndcd}} - !frequency for writing coordinates to the trajectory
      CHARMM-scripts  nsavv 0 - !frequency for writing velocities
      CHARMM-scripts  iasors 1 - !assign (NOT scale) velocities during heating/equil
      CHARMM-scripts  iasvel 1 - !use gaussian distribution of velocities
      CHARMM-scripts  iscvel 0 - !single scale factor
      CHARMM-scripts  ichecw 0 - !checks to make sure avg temperature lies within a window
      CHARMM-scripts  twindh 0.0 - !Highest deviation allowed of FINALT on the high side
      CHARMM-scripts  twindl 0.0 !Highest deviation allowed of FINALT on the low side 
   {% endifequal %} blankme

   {% include 'input_scripts/write_out_struct.inp'%}

   {% if genavg_struct %}
      CHARMM-scripts open unit 31 read file name new_{{filebase}}-md.dcd
      CHARMM-scripts coor dyna firstu 31 nunit 1 sele .not. segid bwat end orient sele .not. segid bwat end
      CHARMM-scripts write coor card name new_{{ filebase }}-mdavg.crd
      CHARMM-scripts * Average coordinates from MD
      CHARMM-scripts *
      CHARMM-scripts
      CHARMM-scripts write coor pdb name new_{{ filebase }}-mdavg.pdb
      CHARMM-scripts * Average coordinates from MD
      CHARMM-scripts *
   {% endif %}
{% endblock %} blankme

