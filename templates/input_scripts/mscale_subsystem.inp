{% extends "input_scripts/generic_charmm_script.inp" %} blankme
{% block title %}Input script for subsystem {{sub.name}}{%endblock%} blankme
{%block read_struct %}{%endblock%}{%comment%}We need to blank this one so that it doesn't load double PSF/CRD{%endcomment%} blankme
{%block body %}
  {%comment %} IF this is a QM system, load the appropriate level of theory, otherwise just don't care. {%endcomment%} blankme
  read psf card name {{psf_path}}subsys/layer{{sub.layer}}.psf
  read coor card name {{psf_path}}subsys/layer{{sub.layer}}.crd

{%if sub.deletion_string%}  !!define reg{{sub.layer}} sele {{sub.deletion_string}} end{%endif%}

  ! get rid of any spare lone pairs that could mess us up...
  ! BTM: I don't think that we need to do this any more, since the main processor wrote out
  ! the PSF and coordinates we're supposed to read...
  !!lonepair clear
  !!delete atom sele .not. ({{sub.selection_string}}) end 

  {% if QM_subsystem %}
  {%comment%}  {% for lonepair in sub.lonepairs %} blankme
    !Re-add the lone pairs for this subsystem
    lonepair colinear dist 0.0 scaled -.7261 sele type qqh{{lonepair.qqh}} end sele atom {{lonepair.qmsegid}} {{lonepair.qmresid}} {{lonepair.qmatomname}} end sele atom {{lonepair.mmsegid}} {{lonepair.mmresid}} {{lonepair.mmatomname}} end
  {%endfor%} blankme{%endcomment%}
  
  !Q-Chem time.
  !Set up environment vars for Q-Chem.
  ENVI qchemcnt "level-{{sub.level_of_theory}}.in"
  ENVI qcheminp "{{sub.name}}.inp"
  ENVI qchemexe "qchem.tim"
  ENVI qchemout "{{sub.name}}.out"


  qchem remove sele all end
  {%endif%} blankme
  
  energy
  
  server
  {%comment%} stop is handled by generic_charmm_script {%endcomment%}
{%endblock%}
